<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agri‚ÄëDash ‚Äì Rekomendasi Komoditas & Ketahanan Pangan</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        :root { --brand:#1f6b3a; --brand-700:#155b2f; }
        html, body { height: 100%; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
        * { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
        *::-webkit-scrollbar { height: 8px; width: 8px; }
        *::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:9999px; }
        .sidebar-active {
          background-color: rgba(255, 255, 255, 0.2);
        }
        .chart-pangan {
          width: 900px;
          margin: 20px auto;
        }
        .legend {
          line-height: 18px;
          color: #555;
          background: white;
          padding: 6px 8px;
          box-shadow: 0 0 6px rgba(0,0,0,0.2);
          border-radius: 8px;
          font-size: 12px;
        }
        .legend i {
          width: 18px;
          height: 18px;
          float: left;
          margin-right: 8px;
          opacity: 0.8;
        }
    </style>
</head>

<body class="bg-[var(--brand)]/95 min-h-full">
<div class="min-h-screen grid grid-cols-12 gap-0">
    <!-- Sidebar -->
    <aside class="col-span-12 lg:col-span-2 bg-[var(--brand)] text-white p-4 lg:p-6 flex flex-col gap-4">
        <div class="flex items-center gap-">
        <div class="w-20 h-20 p-2 rounded overflow-hidden bg-white/10">
        <img src="/assets/logo_pens.png" alt="Profile" class="w-full h-full object-cover">
        </div>

        <div class="w-20 h-20 p-2 rounded overflow-hidden bg-white/10">
        <img src="/assets/Kabupaten_Blitar.jpeg" alt="Profile" class="w-full h-full object-cover">
        </div>
        </div>
        <nav class="mt-4 flex-1">
          <ul class="space-y-2 text-base">
              <li><a class="flex items-center space-x-2 py-2 px-3 rounded-lg hover:bg-green-700 hover:translate-x-2 transition duration-200 ease-in-out transform" href="/index.html">üè† <span>Home</span></a></li>
              <li><a class="flex items-center space-x-2 py-2 px-3 rounded-lg hover:bg-green-700 hover:translate-x-2 transition duration-200 ease-in-out transform" href="/pages/maps.html">üó∫Ô∏è <span>Maps Kecamatan</span></a></li>
              <li><a class="flex items-center space-x-2 py-2 px-3 rounded-lg hover:bg-green-700 hover:translate-x-2 transition duration-200 ease-in-out transform" href="/pages/prediksi.html">üìà <span>Prediksi</span></a></li>
              <li><a class="flex items-center space-x-2 py-2 px-3 rounded-lg hover:bg-green-700 hover:translate-x-2 transition duration-200 ease-in-out transform" href="/pages/pemetaan.html">üß≠ <span>Pemetaan</span></a></li>
              <li><a class="flex items-center space-x-2 py-2 px-3 rounded-lg hover:bg-green-700 hover:translate-x-2 transition duration-200 ease-in-out transform" href="/pages/pemetaan.html">‚úÖ <span>Rekomendasi</span></a></li>
              <li><a class="flex items-center space-x-2 py-2 px-3 rounded-lg hover:bg-green-700 hover:translate-x-2 transition duration-200 ease-in-out transform" href="/pages/ketahanan.html">üõ°Ô∏è <span>Ketahanan Pangan</span></a></li>
          </ul>
        </nav>
        <p class="text-white/70 text-l text-center">¬© Agri‚ÄëDash</p>
    </aside>

    <!-- Main -->
    <main class="col-span-12 lg:col-span-10 bg-[#e8efe9] p-4 lg:p-6 space-y-4">
        <div class="flex flex-col lg:flex-row lg:items-center gap-3 bg-[var(--brand)] p-4 rounded-xl">
            <h1 class="text-white text-2xl lg:text-3xl font-extrabold tracking-tight drop-shadow-sm">
            Dashboard Rekomendasi Komoditas dan Ketahanan Pangan Daerah - AgriDash
            </h1>
        </div>

        <div class="grid grid-cols-12 gap-4">
        <!-- KIRI -->
          <div class="col-span-12 xl:col-span-6 space-y-4">
            <div class="flex flex-col md:flex-row gap-4">
            <!-- Filter Tahun -->
            <div class="bg-white rounded-2xl shadow border border-emerald-100 p-4">
              <h2 class="text-lg font-bold text-emerald-800 mb-4">Jumlah Produksi Tanaman Pangan (Kw)</h2>
              <div id="mapChart" class="w-[708px] h-[400px]"></div>
            </div>
          </div>

            <div class="bg-white rounded-2xl shadow border border-emerald-100 p-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 ">
                  <div>
                    <label class="text-emerald-800 font-bold block mb-1 text-sm">Pilih Tahun</label>
                    <select id="tahunChartSelect" class="border border-slate-200 rounded-lg px-2 py-1 text-sm w-full">
                      <option value="All" >(All)</option>
                      <option value="2018" selected>2018</option>
                      <option value="2019">2019</option>
                      <option value="2020">2020</option>
                      <option value="2021">2021</option>
                      <option value="2022">2022</option>
                      <option value="2023">2023</option>
                    </select>
                  </div>

                  <div>
                    <label class="text-emerald-800 font-bold block mb-1 text-sm">Pilih Kecamatan</label>
                    <select id="kecamatanSelect" class="border border-slate-200 rounded-lg px-2 py-1 text-sm w-full">
                      <option value="All">(All)</option>
                      <option value="Bakung" selected>Bakung</option>
                      <option value="Wonotirto">Wonotirto</option>
                      <option value="Panggungrejo">Panggungrejo</option>
                      <option value="Wates">Wates</option>
                      <option value="Binangun">Binangun</option>
                      <option value="Binangun">Binangun</option>
                      <option value="Kademangan">Kademangan</option>
                      <option value="Kanigoro">Kanigoro</option>
                      <option value="Selopuro">Selopuro</option>
                      <option value="Kesamben">Kesamben</option>
                      <option value="Selorejo">Selorejo</option>
                      <option value="Doko">Doko</option>
                      <option value="Wlingi">Wlingi</option>
                      <option value="Gandusari">Gandusari</option>
                      <option value="Garum">Garum</option>
                      <option value="Nglegok">Nglegok</option>
                      <option value="Sanankulon">Sanankulon</option>
                      <option value="Ponggok">Ponggok</option>
                      <option value="Srengat">Srengat</option>
                      <option value="Wonodadi">Wonodadi</option>
                      <option value="Udanawu">Udanawu</option>
                    </select>
                  </div>

                  <div>
                    <label class="text-emerald-800 font-bold block mb-1 text-sm">Pilih Komoditas</label>
                    <select id="komoditasSelect" class="border border-slate-200 rounded-lg px-2 py-1 text-sm w-full">
                      <option value="All">(All)</option>
                      <option value="rice">Beras</option>
                      <option value="corn">Jagung</option>
                      <option value="peanuts">Kacang Tanah</option>
                      <option value="soybeans">Kedelai</option>
                      <option value="cassava">Ketela Pohon</option>
                      <option value="swpot">Ketela Rambat</option>
                    </select>
                  </div>
              </div>
            </div>

          <div class="bg-white rounded-2xl shadow border border-emerald-100 p-4">
              <h2 class="text-lg font-bold text-emerald-800">Produksi Tanaman Pangan (Kw)</h2>
              <div class="grid grid-cols-4 gap-4">
                <!-- Chart -->
                <div id="donutChart" class="col-span-3 h-[390px]"></div>

                <!-- Legend manual -->
                <div class="col-span-1 flex flex-col justify-center space-y-3 text-sm font-medium">
                  <div class="flex items-center space-x-2">
                    <span class="w-4 h-4 rounded-full bg-blue-500"></span>
                    <span>Padi</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-4 h-4 rounded-full bg-orange-400"></span>
                    <span>Jagung</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-4 h-4 rounded-full bg-green-500"></span>
                    <span>Kacang Tanah</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-4 h-4 rounded-full bg-purple-400"></span>
                    <span>Kedelai</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-4 h-4 rounded-full bg-pink-400"></span>
                    <span>Ketela Pohon</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-4 h-4 rounded-full bg-yellow-400"></span>
                    <span>Ketela Rambat</span>
                  </div>
                </div>
              </div>
          </div>
        </div>

          <!-- KANAN -->
          <div class="col-span-12 xl:col-span-6 space-y-4">
            <!-- Row atas: filter + kotak produksi -->
            <div class="grid grid-cols-12 gap-4">
              <!-- Filter -->
              <div class="col-span-12 md:col-span-4 bg-white rounded-2xl shadow border border-emerald-100 p-4">
                <label class="text-emerald-800 font-bold block mb-2 text-sm">Pilih Tahun</label>
                <select id="tahunSelect" class="border border-slate-200 rounded-lg px-2 py-1 text-sm w-full mb-3">
                  <option value="2018" selected>2018</option>
                  <option value="2019">2019</option>
                  <option value="2020">2020</option>
                  <option value="2021">2021</option>
                  <option value="2022">2022</option>
                  <option value="2023">2023</option>
                </select>

                <label class="text-emerald-800 font-bold block mb-1 text-sm">Pilih Daerah</label>
                <div class="h-20 overflow-y-auto border border-slate-200 rounded-lg p-2 mb-3 text-sm" id="daerahCheckboxes">
                  <label class="block"><input type="checkbox" value="All" name="daerah"> (All)</label>
                  <label class="block"><input type="checkbox" value="South" name="daerah"> Selatan</label>
                  <label class="block"><input type="checkbox" value="North" name="daerah"> Utara</label>
                </div>

                <label class="text-emerald-800 font-bold block mb-2 text-sm">Pilih Komoditas</label>
                <div class="h-40 overflow-y-auto border border-slate-200 rounded-lg p-2 text-sm" id="komoditasCheckboxes">
                  <label class="block"><input type="checkbox" value="All" name="komoditas"> (All)</label>
                  <label class="block"><input type="checkbox" value="corn" name="komoditas"> Jagung</label>
                  <label class="block"><input type="checkbox" value="peanuts" name="komoditas"> Kacang Tanah</label>
                  <label class="block"><input type="checkbox" value="soybeans" name="komoditas"> Kedelai</label>
                  <label class="block"><input type="checkbox" value="cassava" name="komoditas"> Ketela Pohon</label>
                  <label class="block"><input type="checkbox" value="swpot" name="komoditas"> Ketela Rambat</label>
                  <label class="block"><input type="checkbox" value="rice" name="komoditas"> Padi</label>
                </div>
              </div>

              <!-- Produksi Tertinggi -->
              <div class="col-span-12 md:col-span-4 bg-white rounded-2xl shadow border border-emerald-100 p-4">
                <h3 class="text-center font-bold text-emerald-800 mb-2">Produksi Tertinggi</h3>
                <ul id="highestList" class="space-y-1 text-center text-xl"></ul>
              </div>

              <!-- Produksi Terendah -->
              <div class="col-span-12 md:col-span-4 bg-white rounded-2xl shadow border border-emerald-100 p-4">
                <h3 class="text-center font-bold text-emerald-800 mb-2">Produksi Terendah</h3>
                <ul id="lowestList" class="space-y-1 text-center text-xl"></ul>
              </div>
            </div>
            <div class="bg-white rounded-2xl shadow border border-emerald-100 p-4">
              <h2 class="text-lg font-bold text-emerald-800 mb-4">Luas Lahan vs Produksi Komoditas Tanaman Pangan</h2>
              <!-- Horizontal bar comparison -->
                <div id="chart-container" class="grid grid-cols-12 gap-4"></div>
                <div class="mt-3 flex justify-between text-xs text-slate-500"><span>Luas Panen (Ha)</span><span>Produksi (Kw)</span></div>
            </div>
          </div>

    </main>
</div>

<script>
      const menuItems = document.querySelectorAll("nav ul li a");

      menuItems.forEach(item => {
        item.addEventListener("click", function() {
          menuItems.forEach(el => el.classList.remove("sidebar-active"));
          this.classList.add("sidebar-active");
        });
      });

      async function loadBarData() {
          tahun = document.getElementById("tahunSelect").value;
          const res = await fetch(`http://127.0.0.1:8000/api/maps/comparison/${tahun}`);
          const data = await res.json();
          const totalLuas = data.reduce((sum, d) => sum + d.luas_panen, 0);
          const totalProduksi = data.reduce((sum, d) => sum + d.produksi, 0);
          const maxLuasPanen = Math.max(...data.map(d => d.luas_panen));
          const maxProduksi = Math.max(...data.map(d => d.produksi));

          let htmlKiri = `<div class="col-span-6 space-y-2">`;
          let htmlKanan = `<div class="col-span-6 space-y-2">`;

          data.forEach(item => {
              const persenProduksi = ((item.produksi / maxProduksi) * 100).toFixed(1);
              const persenLuas = ((item.luas_panen / maxLuasPanen) * 100).toFixed(1);

              htmlKiri += `
                  <div class="flex items-center gap-2 text-xs">
                      <span class="w-28 truncate">${item.kecamatan}</span>
                      <div class="flex-1 bg-emerald-50 rounded">
                          <div class="h-3 rounded bg-emerald-700" style="width:${persenProduksi}%;"></div>
                      </div>
                      <span class="w-14 text-right">${item.produksi.toLocaleString("id-ID")}</span>
                  </div>
              `;

              htmlKanan += `
                  <div class="flex items-center gap-2 text-xs">
                      <span class="w-28 truncate">${item.kecamatan}</span>
                      <div class="flex-1 bg-amber-50 rounded">
                          <div class="h-3 rounded bg-amber-500" style="width:${persenLuas}%;"></div>
                      </div>
                      <span class="w-16 text-right">${item.luas_panen.toLocaleString("id-ID")}</span>
                  </div>
              `;
          });

          htmlKiri += `</div>`;
          htmlKanan += `</div>`;

          document.getElementById("chart-container").innerHTML = htmlKiri + htmlKanan;
      }
      
      async function loadSortData(tahun) {
        try {
          const response = await fetch(`http://127.0.0.1:8000/api/maps/sort/${tahun}`);
          const data = await response.json();

          const highestList = document.getElementById("highestList");
          const lowestList = document.getElementById("lowestList");

          highestList.innerHTML = "";
          lowestList.innerHTML = "";

          // === Render Produksi Tertinggi ===
          data.highest.forEach((item, index) => {
            const li = document.createElement("li");
            li.className = `font-bold ${index < 2 ? 'text-green-600' : 'text-red-500'}`;
            li.innerHTML = `${item.total.toLocaleString()} Kw<br>${item.District}`;
            highestList.appendChild(li);
          });

          // === Render Produksi Terendah ===
          data.lowest.forEach((item, index) => {
            const li = document.createElement("li");
            li.className = `font-bold ${index < 2 ? 'text-red-500' : 'text-green-600'}`;
            li.innerHTML = `${item.total.toLocaleString()} Kw<br>${item.District}`;
            lowestList.appendChild(li);
          });
        } catch (error) {
          console.error("Gagal load data sort:", error);
        }
      }

let map;
let currentLayer;
let legend;

function initMap() {
  map = L.map("mapChart").setView([-8.142, 123], 9.5);
  L.tileLayer("").addTo(map);

  legend = L.control({ position: "bottomleft" });
  legend.onAdd = function () {
    const div = L.DomUtil.create("div", "info legend bg-white p-2 rounded shadow text-sm");
    div.innerHTML = "<b>- Produksi -</b><br><div id='legend-scale'></div>";
    return div;
  };
  legend.addTo(map);
}

function getColor(d, min, max) {
  const colors = ["#ffeda0", "#feb24c", "#fc4e2a", "#31a354", "#006d2c"];
  if (max === min) return colors[colors.length - 1];
  const step = (max - min) / colors.length;
  if (d <= min + step) return colors[0];
  else if (d <= min + step * 2) return colors[1];
  else if (d <= min + step * 3) return colors[2];
  else if (d <= min + step * 4) return colors[3];
  else return colors[4];
}

function updateLegend(min, max) {
  const grades = [];
  const step = (max - min) / 5;
  for (let i = 0; i <= 5; i++) {
    grades.push(Math.round(min + step * i));
  }

  const legendDiv = document.getElementById("legend-scale");
  legendDiv.innerHTML = "";
  for (let i = 0; i < grades.length - 1; i++) {
    legendDiv.innerHTML += `
      <i style="display:inline-block;width:15px;height:15px;margin-right:5px;background:${getColor(grades[i], min, max)}"></i>
      ${grades[i].toLocaleString()} ‚Äì ${grades[i + 1].toLocaleString()}<br>
    `;
  }
}

async function loadMap(tahun, daerah, komoditas) {
  try {
    const res = await fetch(`http://127.0.0.1:8000/api/maps/maps/${tahun}/${daerah}/${komoditas}`);
    const data = await res.json();

    if (currentLayer) map.removeLayer(currentLayer);

    const values = data.features.map(f => f.properties.total);
    if (values.length === 0) {
      document.getElementById("legend-scale").innerHTML = "<i>Tidak ada data</i>";
      return;
    }

    const minVal = Math.min(...values);
    const maxVal = Math.max(...values);

    currentLayer = L.geoJSON(data, {
      style: feature => ({
        fillColor: getColor(feature.properties.total, minVal, maxVal),
        weight: 1,
        opacity: 1,
        color: "white",
        fillOpacity: 0.8,
      }),
      onEachFeature: (feature, layer) => {
        layer.bindPopup(
          `<b>${feature.properties.nm_kecamatan}</b><br/>Total: ${feature.properties.total.toLocaleString()}`
        );
      },
    }).addTo(map);

    map.fitBounds(currentLayer.getBounds());
    updateLegend(minVal, maxVal);
  } catch (err) {
    console.error("Gagal memuat data peta:", err);
  }
}

function getCheckedValues(containerId) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
  const selected = [];

  checkboxes.forEach(cb => {
    if (cb.checked) {
      if (cb.value === "All") {
        selected.length = 0;
        selected.push("All");
      } else {
        selected.push(cb.value);
      }
    }
  });

  return selected.includes("All") ? ["All"] : selected;
}

function setupCheckboxFilter(containerId, callback) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
  checkboxes.forEach(cb => {
    cb.addEventListener("change", () => {
      if (cb.value === "All" && cb.checked) {
        checkboxes.forEach(c => {
          if (c.value !== "All") c.checked = false;
        });
      } else {
        document.querySelector(`#${containerId} input[value="All"]`).checked = false;
      }
      callback();
    });
  });

  document.querySelector(`#${containerId} input[value="All"]`).checked = true;
}

function refreshMap() {
  const tahun = document.getElementById("tahunSelect").value;
  const daerah = getCheckedValues("daerahCheckboxes").join(",");
  const komoditas = getCheckedValues("komoditasCheckboxes").join(",");
  loadMap(tahun, daerah, komoditas);
}

initMap();
setupCheckboxFilter("daerahCheckboxes", refreshMap);
setupCheckboxFilter("komoditasCheckboxes", refreshMap);

document.getElementById("tahunSelect").addEventListener("change", refreshMap);

// Initial load
loadBarData(2018);
loadSortData(2018);
loadMap(2018, "All", "All");
document.getElementById("tahunSelect").addEventListener("change", function() {
  const tahun = this.value;
  loadBarData(tahun);
  loadSortData(tahun);
  refreshMap();
});

        function getCheckedValues(containerId) {
          const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`);
          const values = Array.from(checkboxes).map(cb => cb.value);

          if (values.includes("All")) {
            return ["All"];
          }
          return values;
        }

        async function loadDonut(tahun, daerah, komoditas) {
          const res = await fetch(`http://127.0.0.1:8000/api/maps/pieMaps/${tahun}/${daerah}/${komoditas}`);
          const json = await res.json();

          if (json.error) {
            console.error(json.error);
            return;
          }

          let labels, values;
          if (komoditas.toLowerCase() === "all") {
            labels = ["Padi", "Jagung", "Ketela Pohon", "Ketela Rambat", "Kacang Tanah", "Kedelai"];
            values = [
              json.data.rice,
              json.data.corn,
              json.data.cassava,
              json.data.swpot,
              json.data.peanuts,
              json.data.soybeans
            ];
          } else {
            labels = [komoditas];
            values = [json.value]; 
          }

          Plotly.newPlot("donutChart", [{
            type: 'pie',
            values: values,
            labels: labels,
            hole: .52,
            marker: {
              colors: ["#3b82f6", "#fb923c", "#ec4899", "#facc15", "#22c55e", "#a855f7"]
            }
          }],
          {
            height: 400,
            width: 500,
            margin: { t: 30, b:25, l: 50, r: 0 },
            showlegend: false
          });
        }

        document.getElementById("tahunChartSelect").addEventListener("change", updateDonut);
        document.getElementById("kecamatanSelect").addEventListener("change", updateDonut);
        document.getElementById("komoditasSelect").addEventListener("change", updateDonut);

        function updateDonut() {
          const tahun = document.getElementById("tahunChartSelect").value;
          const daerah = document.getElementById("kecamatanSelect").value;
          const komoditas = document.getElementById("komoditasSelect").value;

          loadDonut(tahun, daerah, komoditas);
        }

        updateDonut();      
</script>

</body>
</html>
